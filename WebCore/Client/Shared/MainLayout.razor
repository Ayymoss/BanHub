@inject ActiveUserHub ActiveUserHub
@inject StatisticsHub StatisticsHub
@inherits LayoutComponentBase

<MudThemeProvider IsDarkMode="true" Theme="_theme"/>
<MudDialogProvider/>
<MudSnackbarProvider/>
<MudBreakpointProvider/>

<MudLayout Style="height:100vh">
    <MudAppBar DisableGutters="true" Elevation="1">
        <MudElement Class="mx-6 flex-grow-1 d-flex align-center">
            <MudIconButton Class="mr-2" Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="DrawerToggle"/>
            <MudHidden Breakpoint="Breakpoint.SmAndUp" Invert="true">
                <MudElement Class="d-flex mr-4 align-center">
                    <MudText Typo="Typo.h5">Ban Hub</MudText>
                </MudElement>
            </MudHidden>
            <MudHidden Breakpoint="Breakpoint.SmAndUp" Invert="false">
                <MudElement Class="d-flex mr-4 align-center">
                    <MudText Typo="Typo.h4" Class="pl-2">Ban Hub</MudText>
                </MudElement>
            </MudHidden>
            <MudHidden Breakpoint="Breakpoint.SmAndUp" Invert="true" Class="d-flex align-center">
                <MudChip Variant="Variant.Text" Icon="@Icons.Material.Filled.Person" Color="Color.Info">Online &bull; @_online</MudChip>
                <MudChip Variant="Variant.Text" Icon="@Icons.Material.Filled.Block" Color="Color.Error">7d Global Bans &bull; @_bans</MudChip>
            </MudHidden>
            <MudSpacer/>
            <MudIconButton Icon="@Icons.Custom.Brands.Discord" Color="Color.Inherit" Link="https://discord.gg/Arruj6DWvp" Target="_blank"/>
            <MudIconButton Icon="@Icons.Custom.Brands.GitHub" Color="Color.Inherit" Link="https://github.com/Ayymoss/BanHub" Target="_blank"/>
            <MudBadge Content="@_activeUserCount" Bordered="true" Color="Color.Primary" Overlap="true" Class="ml-3 mt-2">
                <MudIcon Icon="@Icons.Material.Filled.RemoveRedEye" Color="Color.Default"/>
            </MudBadge>
        </MudElement>
    </MudAppBar>
    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
        <NavMenu/>
    </MudDrawer>
    <MudMainContent Style="height: 100%;">
        <MudStack Style="height: 100%;">
            <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="my-4 pt-4">
                @Body
            </MudContainer>
            <MudSpacer/>
            <MudAlert Class="ma-2" Severity="Severity.Info" ContentAlignment="HorizontalAlignment.Center">Site in Active Development</MudAlert>
        </MudStack>
    </MudMainContent>
</MudLayout>

@code {

    private readonly MudTheme _theme = Theme.LandingPageTheme();

    private int _online;
    private int _bans;
    private bool _drawerOpen = true;
    private int _activeUserCount;

    void DrawerToggle() => _drawerOpen = !_drawerOpen;

    protected override async Task OnInitializedAsync()
    {
        await InitializeSignalRHubs();
        await base.OnInitializedAsync();
    }

    private async Task InitializeSignalRHubs()
    {
        SubscribeToHubEvents();
        await ActiveUserHub.InitializeAsync();
        await StatisticsHub.InitializeAsync();
    }

    private void SubscribeToHubEvents()
    {
        ActiveUserHub.ActiveUserCountChanged += UpdatePageViewersCount;
        StatisticsHub.OnlineCountChanged += UpdateOnlineCount;
        StatisticsHub.RecentBansCountChanged += UpdateBansCount;
    }

    private void UpdatePageViewersCount(int count)
    {
        _activeUserCount = count;
        StateHasChanged();
    }

    private void UpdateOnlineCount(int count)
    {
        _online = count;
        StateHasChanged();
    }

    private void UpdateBansCount(int count)
    {
        _bans = count;
        StateHasChanged();
    }
}
